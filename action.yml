name: FireflyCI

description: "GitHub action for the command-line interface of the FireflyCI Firefly actions"

inputs:
  version:
    description: FireflyCI Version
    required: false
    default: "latest"
  command:
    description: "FireflyCI command to execute [post-apply, post-plan]"
    required: true
  plan-output-file:
    description: "Path to the plan output file"
    required: false
    default: ''
  plan-log-file:
    description: "Path to the plan log file"
    required: false
    default: ''
  apply-log-file:
    description: "Path to the apply log file"
    required: false
    default: ''
  workspace:
    description: "Workspace identifier"
    required: true
    default: ''
  args:
    description: "Additional arguments for the fireflyci executed command"
    default: ''

runs:
  using: "composite"
  steps:
    - name: Set GitHub Path
      run: echo "$GITHUB_ACTION_PATH" >> $GITHUB_PATH
      shell: bash
      env:
        GITHUB_ACTION_PATH: ${{ github.action_path }}

    - name: Preflight Checks
      run: preflight-checks.sh
      shell: bash
      env:
        FIREFLYCI_VERSION: ${{ inputs.version }}

    - name: FireFlyCI ${{ inputs.command }}
      run: >-
        fireflyci ${{ inputs.command }}
        ${{ inputs.plan-output-file != '' && format('-f {0}', inputs.plan-output-file) || '' }}
        ${{ inputs.plan-log-file != '' && format('-l {0}', inputs.plan-log-file) || '' }}
        ${{ inputs.apply-log-file != '' && format('-f {0}', inputs.apply-log-file) || '' }}
        ${{ inputs.workspace != '' && format('-w {0}', inputs.workspace) || '' }}
        ${{ inputs.args }}
      shell: bash
